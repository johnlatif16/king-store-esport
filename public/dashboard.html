<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard</title>
  <style>
    body{font-family:Arial;margin:0;background:#0f0f1a;color:#fff}
    header{padding:16px;background:#1a1a2e;display:flex;justify-content:space-between;align-items:center}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .card{background:#1a1a2e;padding:16px;border-radius:12px;margin:15px 0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #333;text-align:right;vertical-align:top}
    button{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn{background:#ff7a00;color:#000}
    .danger{background:#ff4d4f;color:#000}
    .muted{color:#ccc}
    img.thumb{width:70px;height:70px;object-fit:cover;border-radius:8px;cursor:pointer;border:1px solid #333}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;padding:20px}
    .modal.show{display:flex}
    .modal img{max-width:95vw;max-height:90vh;border-radius:12px}
    .err{color:#ff4d4f;white-space:pre-wrap}
    .ok{color:#25D366}
    input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#111;color:#fff;margin:8px 0}
  </style>
</head>
<body>
<header>
  <div>لوحة التحكم</div>
  <div>
    <button class="btn" onclick="reloadAll()">تحديث</button>
    <button class="danger" onclick="logout()">خروج</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h2>الطلبات</h2>
    <div id="ordersMsg" class="muted"></div>
    <table>
      <thead>
        <tr>
          <th>العميل</th>
          <th>ID</th>
          <th>النوع</th>
          <th>المبلغ</th>
          <th>الحالة</th>
          <th>رقم التحويل</th>
          <th>سكرين شوت</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="ordersList"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>الاستفسارات</h2>
    <div id="inquiriesMsg" class="muted"></div>
    <table>
      <thead>
        <tr>
          <th>الاسم</th>
          <th>البريد</th>
          <th>التاريخ</th>
          <th>الرسالة</th>
          <th>الحالة</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="inquiriesList"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>الاقتراحات</h2>
    <div id="suggestionsMsg" class="muted"></div>
    <table>
      <thead>
        <tr>
          <th>الاسم</th>
          <th>التواصل</th>
          <th>التاريخ</th>
          <th>الاقتراح</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="suggestionsList"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>إرسال رسالة مباشرة</h2>
    <input id="clientEmail" placeholder="Email العميل" />
    <input id="emailSubject" placeholder="عنوان الرسالة" />
    <textarea id="emailMessage" rows="5" placeholder="نص الرسالة"></textarea>
    <button class="btn" onclick="sendDirectMessage()">إرسال</button>
    <div id="sendMsg" class="muted"></div>
  </div>
</div>

<div id="imgModal" class="modal" onclick="closeModal(event)">
  <img id="modalImg" src="" alt="preview" />
</div>

<script>
  async function safeFetchJson(url, options) {
    const res = await fetch(url, options);
    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); }
    catch { throw new Error("الرد مش JSON:\n" + text.slice(0,120)); }
    if (!res.ok) throw new Error(data?.message || ("HTTP " + res.status));
    return data;
  }

  function openModal(src) {
    document.getElementById("modalImg").src = src;
    document.getElementById("imgModal").classList.add("show");
  }
  function closeModal(e) {
    if (e.target.id === "imgModal") document.getElementById("imgModal").classList.remove("show");
  }

  async function loadOrders() {
    const out = document.getElementById("ordersMsg");
    const tbody = document.getElementById("ordersList");
    out.textContent = "تحميل...";
    tbody.innerHTML = "";

    try {
      const data = await safeFetchJson("/api/admin/orders", { credentials: "include" });
      const orders = data.data || [];
      out.innerHTML = `<span class="ok">عدد الطلبات: ${orders.length}</span>`;

      if (!orders.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="muted">لا توجد طلبات</td></tr>`;
        return;
      }

      for (const o of orders) {
        const tr = document.createElement("tr");
        const item = o.ucAmount ? o.ucAmount + " UC" : o.bundle;
        const shot = o.screenshotUrl ? o.screenshotUrl : null;

        tr.innerHTML = `
          <td><b>${o.name}</b><div class="muted">${o.email}</div></td>
          <td>${o.playerId}</td>
          <td>${o.type}<div class="muted">${item || ""}</div></td>
          <td>${o.totalAmount}</td>
          <td>${o.status}</td>
          <td>${o.transactionId || ""}</td>
          <td>${shot ? `<img class="thumb" src="${shot}" onclick="openModal('${shot}')" />` : "لا يوجد"}</td>
          <td>
            <button class="btn" onclick="toggleStatus(${o.id}, '${o.status === "تم الدفع" ? "لم يتم الدفع" : "تم الدفع"}')">
              ${o.status === "تم الدفع" ? "غير مدفوع" : "مدفوع"}
            </button>
            <button class="danger" onclick="deleteOrder(${o.id})">حذف</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    } catch (err) {
      out.innerHTML = `<div class="err">${String(err.message)}</div>`;
      tbody.innerHTML = `<tr><td colspan="8" class="err">فشل تحميل الطلبات</td></tr>`;
    }
  }

  async function loadInquiries() {
    const out = document.getElementById("inquiriesMsg");
    const tbody = document.getElementById("inquiriesList");
    out.textContent = "تحميل...";
    tbody.innerHTML = "";

    try {
      const data = await safeFetchJson("/api/admin/inquiries", { credentials: "include" });
      const list = data.data || [];
      out.innerHTML = `<span class="ok">عدد الاستفسارات: ${list.length}</span>`;

      if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="muted">لا يوجد</td></tr>`;
        return;
      }

      for (const x of list) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${x.name || ""}</td>
          <td>${x.email}</td>
          <td class="muted">${x.created_at}</td>
          <td>${x.message}</td>
          <td>${x.status}</td>
          <td>
            <button class="btn" onclick="replyInquiry(${x.id}, '${escapeQuotes(x.email)}', '${escapeQuotes(x.message)}')">رد</button>
            <button class="danger" onclick="deleteInquiry(${x.id})">حذف</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    } catch (err) {
      out.innerHTML = `<div class="err">${String(err.message)}</div>`;
      tbody.innerHTML = `<tr><td colspan="6" class="err">فشل تحميل الاستفسارات</td></tr>`;
    }
  }

  async function loadSuggestions() {
    const out = document.getElementById("suggestionsMsg");
    const tbody = document.getElementById("suggestionsList");
    out.textContent = "تحميل...";
    tbody.innerHTML = "";

    try {
      const data = await safeFetchJson("/api/admin/suggestions", { credentials: "include" });
      const list = data.data || [];
      out.innerHTML = `<span class="ok">عدد الاقتراحات: ${list.length}</span>`;

      if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="muted">لا يوجد</td></tr>`;
        return;
      }

      for (const x of list) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${x.name}</td>
          <td>${x.contact}</td>
          <td class="muted">${x.created_at}</td>
          <td>${x.message}</td>
          <td>
            <button class="danger" onclick="deleteSuggestion(${x.id})">حذف</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    } catch (err) {
      out.innerHTML = `<div class="err">${String(err.message)}</div>`;
      tbody.innerHTML = `<tr><td colspan="5" class="err">فشل تحميل الاقتراحات</td></tr>`;
    }
  }

  function escapeQuotes(s) {
    return String(s).replace(/\\/g, "\\\\").replace(/'/g, "\\'");
  }

  async function toggleStatus(id, status) {
    try {
      await safeFetchJson("/api/admin/update-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ id, status })
      });
      await loadOrders();
    } catch (err) {
      alert(err.message);
    }
  }

  async function deleteOrder(id) {
    if (!confirm("حذف الطلب؟")) return;
    try {
      await safeFetchJson(`/api/admin/orders/${id}`, {
        method: "DELETE",
        credentials: "include"
      });
      await loadOrders();
    } catch (err) {
      alert(err.message);
    }
  }

  async function deleteInquiry(id) {
    if (!confirm("حذف الاستفسار؟")) return;
    try {
      await safeFetchJson(`/api/admin/inquiries/${id}`, {
        method: "DELETE",
        credentials: "include"
      });
      await loadInquiries();
    } catch (err) {
      alert(err.message);
    }
  }

  async function deleteSuggestion(id) {
    if (!confirm("حذف الاقتراح؟")) return;
    try {
      await safeFetchJson(`/api/admin/suggestions/${id}`, {
        method: "DELETE",
        credentials: "include"
      });
      await loadSuggestions();
    } catch (err) {
      alert(err.message);
    }
  }

  async function replyInquiry(inquiryId, email, message) {
    const reply = prompt("اكتب الرد:");
    if (!reply) return;

    try {
      await safeFetchJson("/api/admin/reply-inquiry", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ inquiryId, email, message, reply })
      });
      await loadInquiries();
      alert("تم إرسال الرد");
    } catch (err) {
      alert(err.message);
    }
  }

  async function sendDirectMessage() {
    const email = document.getElementById("clientEmail").value.trim();
    const subject = document.getElementById("emailSubject").value.trim();
    const message = document.getElementById("emailMessage").value.trim();
    const out = document.getElementById("sendMsg");

    if (!email || !subject || !message) {
      out.innerHTML = '<div class="err">املأ كل الحقول</div>';
      return;
    }

    out.textContent = "جاري الإرسال...";
    try {
      await safeFetchJson("/api/admin/send-message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ email, subject, message })
      });
      out.innerHTML = '<div class="ok">تم الإرسال</div>';
      document.getElementById("clientEmail").value = "";
      document.getElementById("emailSubject").value = "";
      document.getElementById("emailMessage").value = "";
    } catch (err) {
      out.innerHTML = `<div class="err">${String(err.message)}</div>`;
    }
  }

  async function logout() {
    try {
      await safeFetchJson("/api/admin/logout", {
        method: "POST",
        credentials: "include"
      });
      location.href = "/login.html";
    } catch (err) {
      alert(err.message);
    }
  }

  async function reloadAll() {
    await loadOrders();
    await loadInquiries();
    await loadSuggestions();
  }

  document.addEventListener("DOMContentLoaded", reloadAll);
</script>
</body>
</html>
