<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trip STORE - شحن</title>
  <style>
    body{font-family:Arial;margin:0;background:#0f0f1a;color:#fff}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    .card{background:#1a1a2e;padding:20px;border-radius:12px;margin:15px 0}
    input,select,button{width:100%;padding:12px;border-radius:10px;border:1px solid #333;background:#111;color:#fff;margin:8px 0}
    button{background:#ff7a00;color:#000;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .note{color:#ccc;font-size:14px}
    .ok{color:#25D366}
    .err{color:#ff4d4f}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Trip STORE</h1>
    <p class="note">تأكد إنك بتختار شدات أو حزمة (واحد فقط)، وتكتب رقم التحويل وترفع سكرين شوت.</p>

    <div class="card">
      <h2>معلومات الطلب</h2>
      <form id="orderForm">
        <input id="name" placeholder="الاسم داخل اللعبة" required />
        <input id="playerId" placeholder="ID اللاعب" required />
        <input id="email" type="email" placeholder="البريد الإلكتروني" required />

        <div class="grid">
          <select id="ucAmount">
            <option value="">اختيار شدات (UC)</option>
            <option value="60" data-price="45">60 UC - 45 ج</option>
            <option value="325" data-price="230">325 UC - 230 ج</option>
            <option value="660" data-price="440">660 UC - 440 ج</option>
          </select>

          <select id="bundle">
            <option value="">اختيار حزمة</option>
            <option value="حزمة الازدهار الاولى" data-price="50">حزمة الازدهار الاولى - 50 ج</option>
            <option value="حزمة الازدهار الثانية" data-price="145">حزمة الازدهار الثانية - 145 ج</option>
            <option value="Prime 3 Month" data-price="135">Prime 3 Month - 135 ج</option>
          </select>
        </div>

        <input id="totalAmount" placeholder="المبلغ الإجمالي" readonly />

        <input id="transactionId" placeholder="رقم التحويل (Transaction ID)" required />

        <label class="note">سكرين شوت إثبات الدفع (png/jpg/webp)</label>
        <input id="screenshot" type="file" accept="image/png,image/jpeg,image/webp" required />

        <button id="submitBtn" type="submit">إرسال الطلب</button>
        <div id="msg"></div>
      </form>
    </div>

    <div class="card">
      <h2>استفسار</h2>
      <form id="inquiryForm">
        <input id="inqName" placeholder="اسمك" required />
        <input id="inqEmail" type="email" placeholder="بريدك" required />
        <input id="inqMessage" placeholder="رسالتك" required />
        <button type="submit">إرسال الاستفسار</button>
        <div id="inqMsg"></div>
      </form>
    </div>

    <div class="card">
      <h2>اقتراح</h2>
      <form id="suggestForm">
        <input id="sugName" placeholder="اسمك" required />
        <input id="sugContact" placeholder="وسيلة التواصل" required />
        <input id="sugMessage" placeholder="اقتراحك" required />
        <button type="submit">إرسال الاقتراح</button>
        <div id="sugMsg"></div>
      </form>
    </div>
  </div>

  <script>
    async function safeFetchJson(url, options) {
      const res = await fetch(url, options);
      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); }
      catch {
        throw new Error("الرد مش JSON. أول 120 حرف:\n" + text.slice(0,120));
      }
      if (!res.ok) {
        throw new Error(data?.message || ("HTTP " + res.status));
      }
      return data;
    }

    function setTotal() {
      const ucSel = document.getElementById("ucAmount");
      const bSel = document.getElementById("bundle");

      const ucOpt = ucSel.options[ucSel.selectedIndex];
      const bOpt = bSel.options[bSel.selectedIndex];

      const ucPrice = ucSel.value ? Number(ucOpt.dataset.price || 0) : 0;
      const bPrice = bSel.value ? Number(bOpt.dataset.price || 0) : 0;

      document.getElementById("totalAmount").value = (ucPrice + bPrice) ? (ucPrice + bPrice) : "";
    }

    document.getElementById("ucAmount").addEventListener("change", (e) => {
      if (e.target.value) document.getElementById("bundle").value = "";
      setTotal();
    });

    document.getElementById("bundle").addEventListener("change", (e) => {
      if (e.target.value) document.getElementById("ucAmount").value = "";
      setTotal();
    });

    // ORDER
    document.getElementById("orderForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = document.getElementById("msg");
      const btn = document.getElementById("submitBtn");

      const ucAmount = document.getElementById("ucAmount").value;
      const bundle = document.getElementById("bundle").value;
      if (!ucAmount && !bundle) {
        msg.innerHTML = '<p class="err">لازم تختار شدات أو حزمة.</p>';
        return;
      }

      const file = document.getElementById("screenshot").files[0];
      if (!file) {
        msg.innerHTML = '<p class="err">السكرين شوت مطلوب.</p>';
        return;
      }

      const fd = new FormData();
      fd.append("name", document.getElementById("name").value);
      fd.append("playerId", document.getElementById("playerId").value);
      fd.append("email", document.getElementById("email").value);
      fd.append("ucAmount", ucAmount);
      fd.append("bundle", bundle);
      fd.append("totalAmount", document.getElementById("totalAmount").value);
      fd.append("transactionId", document.getElementById("transactionId").value);
      fd.append("screenshot", file);

      btn.disabled = true;
      msg.innerHTML = '<p class="note">جاري الإرسال...</p>';

      try {
        const data = await safeFetchJson("/api/order", {
          method: "POST",
          credentials: "include",
          body: fd
        });

        msg.innerHTML = `<p class="ok">تم إرسال الطلب بنجاح. رقم الطلب: ${data.id}</p>`;
        e.target.reset();
        document.getElementById("totalAmount").value = "";
      } catch (err) {
        msg.innerHTML = `<pre class="err">${String(err.message)}</pre>`;
      } finally {
        btn.disabled = false;
      }
    });

    // INQUIRY
    document.getElementById("inquiryForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const out = document.getElementById("inqMsg");
      out.innerHTML = '<p class="note">جاري الإرسال...</p>';

      try {
        await safeFetchJson("/api/inquiry", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({
            name: document.getElementById("inqName").value,
            email: document.getElementById("inqEmail").value,
            message: document.getElementById("inqMessage").value
          })
        });

        out.innerHTML = '<p class="ok">تم إرسال الاستفسار بنجاح.</p>';
        e.target.reset();
      } catch (err) {
        out.innerHTML = `<pre class="err">${String(err.message)}</pre>`;
      }
    });

    // SUGGESTION
    document.getElementById("suggestForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const out = document.getElementById("sugMsg");
      out.innerHTML = '<p class="note">جاري الإرسال...</p>';

      try {
        await safeFetchJson("/api/suggestion", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({
            name: document.getElementById("sugName").value,
            contact: document.getElementById("sugContact").value,
            message: document.getElementById("sugMessage").value
          })
        });

        out.innerHTML = '<p class="ok">تم إرسال الاقتراح بنجاح.</p>';
        e.target.reset();
      } catch (err) {
        out.innerHTML = `<pre class="err">${String(err.message)}</pre>`;
      }
    });
  </script>
</body>
</html>
